(function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],i):t.clippy=i(t.$)})(this,function(t){"use strict";function i(t,i){var e=a._getAgentDfd(t);e.resolve(i)}function e(i,e){var o=a._sounds[i];o||(o=a._sounds[i]=t.Deferred()),o.resolve(e)}t="default"in t?t.default:t;var o=function(t){this._queue=[],this._onEmptyCallback=t};o.prototype.queue=function(t){this._queue.push(t),1!==this._queue.length||this._active||this._progressQueue()},o.prototype._progressQueue=function(){if(!this._queue.length)return void this._onEmptyCallback();var i=this._queue.shift();this._active=!0;var e=t.proxy(this.next,this);i(e)},o.prototype.clear=function(){this._queue=[]},o.prototype.next=function(){this._active=!1,this._progressQueue()};var n=function(i,e,o,n){var s=this;this._el=i,this._data=o,this._path=e,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(n),this._overlays=[this._el];var r=this._el;this._setupElement(this._el);for(var a=1;a<this._data.overlayCount;a++){var h=s._setupElement(t("<div></div>"));r.append(h),s._overlays.push(h),r=h}};n.prototype._setupElement=function(t){var i=this._data.framesize;return t.css("display","none"),t.css({width:i[0],height:i[1]}),t.css("background","url('"+this._path+"/map.png') no-repeat"),t},n.prototype.animations=function(){var t=[],i=this._data.animations;for(var e in i)t.push(e);return t},n.prototype.preloadSounds=function(t){for(var i=this,e=0;e<this._data.sounds.length;e++){var o=i._data.sounds[e],n=t[o];n&&(i._sounds[o]=new Audio(n))}},n.prototype.hasAnimation=function(t){return!!this._data.animations[t]},n.prototype.exitAnimation=function(){this._exiting=!0},n.prototype.showAnimation=function(t,i){return this._exiting=!1,!!this.hasAnimation(t)&&(this._currentAnimation=this._data.animations[t],this.currentAnimationName=t,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=i,!0)},n.prototype._draw=function(){var t=this,i=[];this._currentFrame&&(i=this._currentFrame.images||[]);for(var e=0;e<this._overlays.length;e++)if(e<i.length){var o=i[e],n=-o[0]+"px "+-o[1]+"px";t._overlays[e].css({"background-position":n,display:"block"})}else t._overlays[e].css("display","none")},n.prototype._getNextAnimationFrame=function(){if(this._currentAnimation){if(!this._currentFrame)return 0;var t=this._currentFrame,i=this._currentFrame.branching;if(this._exiting&&void 0!==t.exitBranch)return t.exitBranch;if(i)for(var e=100*Math.random(),o=0;o<i.branches.length;o++){var n=i.branches[o];if(e<=n.weight)return n.frameIndex;e-=n.weight}return this._currentFrameIndex+1}},n.prototype._playSound=function(){var t=this._currentFrame.sound;if(t){var i=this._sounds[t];i&&i.play()}},n.prototype._atLastFrame=function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},n.prototype._step=function(){if(this._currentAnimation){var i=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),e=!this._currentFrame||this._currentFrameIndex!==i;this._currentFrameIndex=i,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout(t.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&e&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,n.States.WAITING):this._endCallback(this.currentAnimationName,n.States.EXITED))}},n.prototype.pause=function(){window.clearTimeout(this._loop)},n.prototype.resume=function(){this._step()},n.States={WAITING:1,EXITED:0};var s=function(t){this._targetEl=t,this._hidden=!0,this._setup(),this.WORD_SPEAK_TIME=200,this.CLOSE_BALLOON_DELAY=2e3,this._BALLOON_MARGIN=15};s.prototype._setup=function(){this._balloon=t('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),t(document.body).append(this._balloon)},s.prototype.reposition=function(){for(var t=this,i=["top-left","top-right","bottom-left","bottom-right"],e=0;e<i.length;e++){var o=i[e];if(t._position(o),!t._isOut())break}},s.prototype._position=function(i){var e=this._targetEl.offset(),o=this._targetEl.height(),n=this._targetEl.width();e.top-=t(window).scrollTop(),e.left-=t(window).scrollLeft();var s=this._balloon.outerHeight(),r=this._balloon.outerWidth();this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left");var a,h;switch(i){case"top-left":a=e.left+n-r,h=e.top-s-this._BALLOON_MARGIN;break;case"top-right":a=e.left,h=e.top-s-this._BALLOON_MARGIN;break;case"bottom-right":a=e.left,h=e.top+o+this._BALLOON_MARGIN;break;case"bottom-left":a=e.left+n-r,h=e.top+o+this._BALLOON_MARGIN}this._balloon.css({top:h,left:a}),this._balloon.addClass("clippy-"+i)},s.prototype._isOut=function(){var i=this._balloon.offset(),e=this._balloon.outerHeight(),o=this._balloon.outerWidth(),n=t(window).width(),s=t(window).height(),r=t(document).scrollTop(),a=t(document).scrollLeft(),h=i.top-r,p=i.left-a,u=5;return h-u<0||p-u<0||(h+e+u>s||p+o+u>n)},s.prototype.speak=function(t,i,e){this._hidden=!1,this.show();var o=this._content;o.height("auto"),o.width("auto"),o.text(i),o.height(o.height()),o.width(o.width()),o.text(""),this.reposition(),this._complete=t,this._sayWords(i,e,t)},s.prototype.show=function(){this._hidden||this._balloon.show()},s.prototype.hide=function(i){return i?void this._balloon.hide():void(this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))},s.prototype._finishHideBalloon=function(){this._active||(this._balloon.hide(),this._hidden=!0,this._hiding=null)},s.prototype._sayWords=function(i,e,o){this._active=!0,this._hold=e;var n=i.split(/[^\S-]/),s=this.WORD_SPEAK_TIME,r=this._content,a=1;this._addWord=t.proxy(function(){this._active&&(a>n.length?(delete this._addWord,this._active=!1,this._hold||(o(),this.hide())):(r.text(n.slice(0,a).join(" ")),a++,this._loop=window.setTimeout(t.proxy(this._addWord,this),s)))},this),this._addWord()},s.prototype.close=function(){this._active?this._hold=!1:this._hold&&this._complete()},s.prototype.pause=function(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},s.prototype.resume=function(){this._addWord?this._addWord():this._hold||this._hidden||(this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))};var r=function(i,e,r){this.path=i,this._queue=new o(t.proxy(this._onQueueEmpty,this)),this._el=t('<div class="clippy"></div>').hide(),t(document.body).append(this._el),this._animator=new n(this._el,i,e,r),this._balloon=new s(this._el),this._setupEvents()};r.prototype.gestureAt=function(t,i){var e=this._getDirection(t,i),o="Gesture"+e,n="Look"+e,s=this.hasAnimation(o)?o:n;return this.play(s)},r.prototype.hide=function(t,i){this._hidden=!0;var e=this._el;return this.stop(),t?(this._el.hide(),this.stop(),this.pause(),void(i&&i())):this._playInternal("Hide",function(){e.hide(),this.pause(),i&&i()})},r.prototype.moveTo=function(i,e,o){var s=this._getDirection(i,e),r="Move"+s;void 0===o&&(o=1e3),this._addToQueue(function(s){if(0===o)return this._el.css({top:e,left:i}),this.reposition(),void s();if(!this.hasAnimation(r))return void this._el.animate({top:e,left:i},o,s);var a=t.proxy(function(r,a){a===n.States.EXITED&&s(),a===n.States.WAITING&&this._el.animate({top:e,left:i},o,t.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(r,a)},this)},r.prototype._playInternal=function(i,e){this._isIdleAnimation()&&this._idleDfd&&"pending"===this._idleDfd.state()&&this._idleDfd.done(t.proxy(function(){this._playInternal(i,e)},this)),this._animator.showAnimation(i,e)},r.prototype.play=function(i,e,o){return!!this.hasAnimation(i)&&(void 0===e&&(e=5e3),this._addToQueue(function(s){var r=!1,a=function(t,i){i===n.States.EXITED&&(r=!0,o&&o(),s())};e&&window.setTimeout(t.proxy(function(){r||this._animator.exitAnimation()},this),e),this._playInternal(i,a)},this),!0)},r.prototype.show=function(i){if(this._hidden=!1,i)return this._el.show(),this.resume(),void this._onQueueEmpty();if("auto"===this._el.css("top")||"auto"===!this._el.css("left")){var e=.8*t(window).width(),o=.8*(t(window).height()+t(document).scrollTop());this._el.css({top:o,left:e})}return this.resume(),this.play("Show")},r.prototype.speak=function(t,i){this._addToQueue(function(e){this._balloon.speak(e,t,i)},this)},r.prototype.closeBalloon=function(){this._balloon.hide()},r.prototype.delay=function(t){t=t||250,this._addToQueue(function(i){this._onQueueEmpty(),window.setTimeout(i,t)})},r.prototype.stopCurrent=function(){this._animator.exitAnimation(),this._balloon.close()},r.prototype.stop=function(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()},r.prototype.hasAnimation=function(t){return this._animator.hasAnimation(t)},r.prototype.animations=function(){return this._animator.animations()},r.prototype.animate=function(){var t=this.animations(),i=t[Math.floor(Math.random()*t.length)];return 0===i.indexOf("Idle")?this.animate():this.play(i)},r.prototype._getDirection=function(t,i){var e=this._el.offset(),o=this._el.height(),n=this._el.width(),s=e.left+n/2,r=e.top+o/2,a=r-i,h=s-t,p=Math.round(180*Math.atan2(a,h)/Math.PI);return-45<=p&&p<45?"Right":45<=p&&p<135?"Up":135<=p&&p<=180||-180<=p&&p<-135?"Left":-135<=p&&p<-45?"Down":"Top"},r.prototype._onQueueEmpty=function(){if(!this._hidden&&!this._isIdleAnimation()){var i=this._getIdleAnimation();this._idleDfd=t.Deferred(),this._animator.showAnimation(i,t.proxy(this._onIdleComplete,this))}},r.prototype._onIdleComplete=function(t,i){i===n.States.EXITED&&this._idleDfd.resolve()},r.prototype._isIdleAnimation=function(){var t=this._animator.currentAnimationName;return t&&0===t.indexOf("Idle")},r.prototype._getIdleAnimation=function(){for(var t=this.animations(),i=[],e=0;e<t.length;e++){var o=t[e];0===o.indexOf("Idle")&&i.push(o)}var n=Math.floor(Math.random()*i.length);return i[n]},r.prototype._setupEvents=function(){t(window).on("resize",t.proxy(this.reposition,this)),this._el.on("mousedown",t.proxy(this._onMouseDown,this)),this._el.on("dblclick",t.proxy(this._onDoubleClick,this))},r.prototype._onDoubleClick=function(){this.play("ClickedOn")||this.animate()},r.prototype.reposition=function(){if(this._el.is(":visible")){var i=this._el.offset(),e=this._el.outerHeight(),o=this._el.outerWidth(),n=t(window).width(),s=t(window).height(),r=t(window).scrollTop(),a=t(window).scrollLeft(),h=i.top-r,p=i.left-a,u=5;h-u<0?h=u:h+e+u>s&&(h=s-e-u),p-u<0?p=u:p+o+u>n&&(p=n-o-u),this._el.css({left:p,top:h}),this._balloon.reposition()}},r.prototype._onMouseDown=function(t){t.preventDefault(),this._startDrag(t)},r.prototype._startDrag=function(i){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(i),this._moveHandle=t.proxy(this._dragMove,this),this._upHandle=t.proxy(this._finishDrag,this),t(window).on("mousemove",this._moveHandle),t(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},r.prototype._calculateClickOffset=function(t){var i=t.pageX,e=t.pageY,o=this._el.offset();return{top:e-o.top,left:i-o.left}},r.prototype._updateLocation=function(){this._el.css({top:this._targetY,left:this._targetX}),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},r.prototype._dragMove=function(t){t.preventDefault();var i=t.clientX-this._offset.left,e=t.clientY-this._offset.top;this._targetX=i,this._targetY=e},r.prototype._finishDrag=function(){window.clearTimeout(this._dragUpdateLoop),t(window).off("mousemove",this._moveHandle),t(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},r.prototype._addToQueue=function(i,e){e&&(i=t.proxy(i,e)),this._queue.queue(i)},r.prototype.pause=function(){this._animator.pause(),this._balloon.pause()},r.prototype.resume=function(){this._animator.resume(),this._balloon.resume()};var a=function i(e,o,n,s){s=s||window.CLIPPY_CDN||"https://gitcdn.xyz/repo/pi0/clippyjs/master/assets/agents/";var a,h=s+e,p=i._loadMap(h),u=i._loadAgent(e,h),l=i._loadSounds(e,h);u.done(function(t){a=t});var _;l.done(function(t){_=t});var d=function(){var t=new r(h,a,_);o(t)};t.when(p,u,l).done(d).fail(n)};a._loadMap=function(i){var e=a._maps[i];if(e)return e;e=a._maps[i]=t.Deferred();var o=i+"/map.png",n=new Image;return n.onload=e.resolve,n.onerror=e.reject,n.setAttribute("src",o),e.promise()},a._loadSounds=function(i,e){var o=a._sounds[i];if(o)return o;o=a._sounds[i]=t.Deferred();var n=document.createElement("audio"),s=!!n.canPlayType&&""!==n.canPlayType("audio/mpeg"),r=!!n.canPlayType&&""!==n.canPlayType('audio/ogg; codecs="vorbis"');if(s||r){var h=e+(s?"/sounds-mp3.js":"/sounds-ogg.js");a._loadScript(h)}else o.resolve({});return o.promise()},a._loadAgent=function(t,i){var e=a._data[t];if(e)return e;e=a._getAgentDfd(t);var o=i+"/agent.js";return a._loadScript(o),e.promise()},a._loadScript=function(t){var i=document.createElement("script");i.setAttribute("src",t),i.setAttribute("async","async"),i.setAttribute("type","text/javascript"),document.head.appendChild(i)},a._getAgentDfd=function(i){var e=a._data[i];return e||(e=a._data[i]=t.Deferred()),e},a._maps={},a._sounds={},a._data={};var h={Agent:r,Animator:n,Queue:o,Balloon:s,load:a,ready:i,soundsReady:e};return"undefined"!=typeof window&&(window.clippy=h),h});